---
title:      《System Performance》笔记，chap1，case study
layout:     post
category:   blog
tags:       [tomcat, translation, java, "System Performance"]
---


# case 1: slow disks

## 现象

dba通报有些sql的执行时间超过1s，以往并不常见，但在过去的一周内却达到了每小时有几十条慢sql，同时硬盘很忙，使用率达到80%，但其他硬件使用情况（如CPU使用率）却并不高。从历史数据看，过去一周中，硬盘和CPU的使用率一直比较稳定。

## 处理过程

Scott（故事的主人公，系统管理员）的处理过程如下：

1. 检查磁盘错误数量，数值为0；
2. 使用iostat检查读写IO情况，以1分钟为间隔来看的话，磁盘使用率为80%，而以1s为间隔来看的话，常常会得到100%，造成吞吐量饱和，增加了磁盘IO的延迟；
3. 为了证明造成磁盘使用率高不是由于执行sql查询语句引起的，使用基于动态追踪的脚本来记录执行时间和栈引用记录；
4. 步骤3的结果显示，数据库通常会被阻塞在对文件系统的读操作上，即执行查询语句上，时间长达数毫秒，从而证明性能问题是由于磁盘使用率太高造成的；
5. 排查磁盘使用率太高的原因，从统计数据上看，磁盘使用率和负载成正相关关系。使用`iostat`等工具来测算IOPS、吞吐量、磁盘IO的平均延迟、读写比例，以及每次IO操作的平均大小，借以估测是随机IO操作还是顺序IO操作；
6. 为了获得更详细的内容，Scott使用了磁盘IO级追踪技术，结果证明问题就在于磁盘IO遇到了高负载，而非磁盘本身出现了故障；
7. 从磁盘操作日志看，并没有明显的异常行为，而DBA团队反馈"数据库负载并无明显提升，SQL查询频率也比较正常"，这一点也印证了之前的探查结果，"CPU负载并无明显提升"；
8. 思考"在什么情况下会使磁盘负载提升，但却不会引发CPU负载提升"，一位同事提议检查文件系统碎片（file system fragmentation），经检查，碎片化只有30%；
9. 在思考了内核的IO调用栈后，忽然想到文件系统缓存（页缓存）未命中频率太多的话，也会提升磁盘负载；
10. 他检查了文件系统的缓存命中率，数值为91%，看起来还不错，不过由于没有历史数据，无法做纵向比较，但其他数据库服务器的文件系统缓存命中率都超过了97%，此外，还发现问题服务器的文件系统缓存容量也比其他数据库服务器大得多；
11. 这时他注意到一个之前被忽视的事情，在问题服务器上，还运行着一个原型应用程序，虽然不是用于生产环境，但也消耗了不少内存，占用了文件系统缓存，降低了缓存的命中率，进而提升磁盘负载，造成了数据库系统的性能问题；
12. 联系原型应用程序的开发团队，将该应用程序移到其他服务器上，于是乎一切恢复正常。

## 分析

