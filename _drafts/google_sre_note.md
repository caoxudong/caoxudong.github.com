---
title:      《SRE-Google运维解密》笔记
layout:     post
category:   blog
tags:       [sre, note]
---

>《SRE-Google运维解密》，https://book.douban.com/subject/26875239/

# chap1 介绍

短期来看，专门的运维团队方便分工、招聘，快速部署应用，但这种方式割裂了开发和运维的角色，是双方有不同的关注点，长此以往会产生沟通成本和协作成本。开发人员想快速上线，运维人员想系统稳定，最终是运维人员设计各类规范，开发人员钻各类空子。

Google的做法的建立SRE(site reliability Engineering)团队来管理系统和应用，这个团队会完成一些运维任务，但更多的是要保障系统稳定可靠，具体落地是开发各类系统和运维工具，支撑业务稳定运行。这与运维团队的区别是，强调开发、强调自动化，而不是单纯靠运维人员手工操作。例如，团队保证至少有50%的时间在做开发。

这种方案需要领导层的支撑，即便在业务繁忙的时候，也要坚持，否则肯定会被业务方逼死，实在忙不过来，就增派人手，或是调开发人员临时支援，而不是将SRE团队的开发时间缩短。

如果真的能坚持下来，建立出色的SRE团队，将会对业务、公司的长远发展带来巨大的收益。

这里指的关注的是对待繁重琐事的方法，坚持将琐事、杂事自动化，提升做事效率。

# chap2 Google生产环境: SRE视角

简单介绍了相关环境

* 硬件
* 管理物理服务器的系统管理软件
    * 管理物理服务器: Borg，分布式集群操作系统，（其新一代产品是kubernetes），负责在集群层面管理任务的编排工作。
    * 存储: bigtable, spanner, etc
    * 网络: sdn
* 其他系统软件
    * 分布式锁: chubby
    * 监控报警系统

Borg(kubernetes)需要学习一下。

# chap3 拥抱风险

过分强调可用性的问题:

* 过高的成本: 资源（服务，服务器），时间
* 限制了产品的创新和发布

计算可用性的方式

1. 可用性 = 正常运行时间 / （正常运行时间 + 停机时间）
1. 可用性 = 成功请求数 / 总请求数

方式1的问题在于，对于大规模部署的服务，会有一些降级和错误处理策略，从而总是会有部分服务在运行，保障服务可用，因此整体来看服务总是正常运行，此时可以使用方式2来计算可用性。

要关注的问题依然落脚于成本-收益的分析，做一个可用性100%的系统，需要在设计-开发-部署等环境花费大量精力/资源，但100%的可用性和99%可用性的成本差异，对于最终收益来说，真的有必要么，需要SRE和产品负责人仔细衡量。

以分布式锁为例，这个东西可大可小，粗略实现`set nx`就好，但严格来说是有问题的，100%严格可靠的分布式锁，成本又极高，那么平衡了效率和成本后，`sex nx`就够用了。

# chap4 服务质量目标

* **SLI**: service level index，服务质量指标，一般是监控指标
* **SLO**: service level object，服务质量目标，监控指标的阈值设定
* **SLA**: service level agreement，服务质量协议，未达到SLO时的处置方案，例如惩罚条款

SLI的设定未必是所有的监控指标，需要与具体的产品业务相结合，选择关键性指标。

SLO的设定需要与产品业务商定，找出业务需要哪些目标。

SLA因为涉及到处置方案，是商业协商的结果。

SLO设定的原则：

* 不要以目前的状态为基础选择目标：要有全局思维，发展视角，避免将关注点局限于当前
* 保持简单：SLI过于复杂的汇总方式，可能会掩盖系统中的性能问题，也不便于理解
* 避免绝对值：要从用户的实际需求触发，避免过度要求
* 越少越好：如无必要，勿增实体
* 不要追求完美：可以循序渐进的优化，贪多嚼不烂

另外，提到了故意制造故障的事情。有的时候，你的系统很健壮，超过了SLO的设定，让上游系统产生了过强的依赖，因此要故意制造点故障，提升上游系统的稳定性。有点类似于线上故障制造系统。高，实在是高。

# chap5 减少琐事

重复的、可自动化的手工操作需要将之改造为自动化的工程项目。

重要不紧急。

# chap6 分布式系统监控

4个黄金指标

* 延迟
* 流量
* 错误
* 饱和度

监控会暴露问题，但解决问题要从根源入手，不可将时间过多花在打补丁上。

# chap7 google的自动化系统演进

想办法让自己从手工的、重复的、充满不确定性的工作中抽离出来，使用自动化的、具有一致性的、平台型的服务来帮助你处理那些琐事。

# chap8 发布工程

4个主要观点

* 自服务模型： 自动化
* 追求速度：不仅是单纯追求上线快，更多的通过频繁迭代，减小版本间差异
* 密闭性：构建结果不受构建环境影响
* 强调策略和流程

# chap9 简单化

想办法让你负责的系统变简单，简单的系统更容易理解、更容易维护。

* 系统设计
* api设计
* 代码结构
* 代码实现


# chap10 基于时间序列数据进行有效报警

每个服务都有一个http接口，该接口会暴露系统服务内部的运行时数据，供监控系统定期抓取。

使用时序数据库设计监控报警系统。

# chap11 on-call轮值

sre的关键在于平衡琐碎事情和开发系统工具的时间。

# chap12 有效的故障排查手段

监控，正确的监控，合适的监控

# chap13 紧急事件响应

混沌系统助力系统健康、稳定，关注复盘、关注细节。

# chap14 紧急事故管理

当发生故障时，切忌手忙脚乱，切忌闷头瞎搞，要多沟通、明确分工职责