---
title:      Tomcat初始化
layout:     post
category:   blog
tags:       [tomcat, java]
---

>Tomcat版本为8.0.28

1. org.apache.catalina.startup.BootStrap
    1. 初始化`catalina.home` 
        1. 获取参数`catalina.home`，判断相应目录是否存在，若不存在则
        1. 查看当前工作目录是否存在bootstrap.jar文件，若存在，则以父目录作为`catalina.home`的值，否则
        1. 使用当前目录作为`catalina.home`的值
    1. 初始化`catalina.base`
        1. 获取参数`catalina.base`，若值不为空，则根据其值设置相应的变量，否则
        1. 设置为`catalina.home`的值
    1. 调用init方法，初始化类加载器
        1. 加载`catalina.properties`
        1. 创建common类加载器（commonLoader）
            1. 查询`common.loader`属性的值，拆解其中的类路径，根据创建`Repository`实例组
            1. 遍历`Repository`实例组，去重，创建URLClassLoader实例
        1. 创建server类加载器（catalinaLoader）
            1. 查询`server.loader`属性的值，拆解其中的类路径，根据创建`Repository`实例组
            1. 遍历`Repository`实例组，去重，创建URLClassLoader实例
        1. 创建shared类加载器（sharedLoader）
            1. 查询`shared.loader`属性的值，拆解其中的类路径，根据创建`Repository`实例组
            1. 遍历`Repository`实例组，去重，创建URLClassLoader实例
        1. 设置线程上下文类加载器为`catalinaLoader`
        1. 使用`catalinaLoader`加载基础类
            1. loadCorePackage
                * org.apache.catalina.core.AccessLogAdapter
                * org.apache.catalina.core.ApplicationContextFacade$1
                * org.apache.catalina.core.ApplicationDispatcher$PrivilegedForward
                * org.apache.catalina.core.ApplicationDispatcher$PrivilegedInclude
                * org.apache.catalina.core.AsyncContextImpl
                * org.apache.catalina.core.AsyncContextImpl$DebugException
                * org.apache.catalina.core.AsyncContextImpl$1
                * org.apache.catalina.core.AsyncListenerWrapper
                * org.apache.catalina.core.ContainerBase$PrivilegedAddChild
                * org.apache.catalina.core.DefaultInstanceManager$1
                * org.apache.catalina.core.DefaultInstanceManager$2
                * org.apache.catalina.core.DefaultInstanceManager$3
                * org.apache.catalina.core.DefaultInstanceManager$AnnotationCacheEntry
                * org.apache.catalina.core.DefaultInstanceManager$AnnotationCacheEntryType
                * org.apache.catalina.core.ApplicationHttpRequest$AttributeNamesEnumerator
            1. loadCoyotePackage
                * org.apache.coyote.http11.AbstractOutputBuffer$1
                * org.apache.coyote.http11.Constants
                * org.apache.coyote.Constants
            1. loadLoaderPackage
                * org.apache.catalina.loader.WebappClassLoaderBase$PrivilegedFindResourceByName
            1. loadRealmPackage
                * org.apache.catalina.realm.LockOutRealm$LockRecord
            1. loadServletsPackage
                * org.apache.catalina.servlets.DefaultServlet
            1. loadSessionPackage
                * org.apache.catalina.session.StandardSession
                * org.apache.catalina.session.StandardSession$1
                * org.apache.catalina.session.StandardManager$PrivilegedDoUnload
            1. loadUtilPackage
                * org.apache.catalina.util.ParameterMap
                * org.apache.catalina.util.RequestUtil
            1. loadValvesPackage
                * org.apache.catalina.valves.AbstractAccessLogValve$3
            1. loadJavaxPackage
                * javax.servlet.http.Cookie
            1. loadConnectorPackage
                * org.apache.catalina.connector.RequestFacade$GetAttributePrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetParameterMapPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetRequestDispatcherPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetParameterPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetParameterNamesPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetCharacterEncodingPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetHeadersPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetHeaderNamesPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetCookiesPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetLocalePrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetLocalesPrivilegedAction
                * org.apache.catalina.connector.ResponseFacade$SetContentTypePrivilegedAction
                * org.apache.catalina.connector.ResponseFacade$DateHeaderPrivilegedAction
                * org.apache.catalina.connector.RequestFacade$GetSessionPrivilegedAction
                * org.apache.catalina.connector.ResponseFacade$1
                * org.apache.catalina.connector.OutputBuffer$1
                * org.apache.catalina.connector.CoyoteInputStream$1
                * org.apache.catalina.connector.CoyoteInputStream$2
                * org.apache.catalina.connector.CoyoteInputStream$3
                * org.apache.catalina.connector.CoyoteInputStream$4
                * org.apache.catalina.connector.CoyoteInputStream$5
                * org.apache.catalina.connector.InputBuffer$1
                * org.apache.catalina.connector.Response$1
                * org.apache.catalina.connector.Response$2
                * org.apache.catalina.connector.Response$3
            1. loadTomcatPackage
                * org.apache.tomcat.util.buf.HexUtils
                * org.apache.tomcat.util.buf.StringCache
                * org.apache.tomcat.util.buf.StringCache$ByteEntry
                * org.apache.tomcat.util.buf.StringCache$CharEntry
                * org.apache.tomcat.util.http.FastHttpDateFormat
                * org.apache.tomcat.util.http.HttpMessages
                * org.apache.tomcat.util.http.parser.HttpParser
                * org.apache.tomcat.util.http.parser.MediaType
                * org.apache.tomcat.util.http.parser.MediaTypeCache
                * org.apache.tomcat.util.http.parser.SkipResult
                * org.apache.tomcat.util.net.Constants
                * org.apache.tomcat.util.net.DispatchType
                * org.apache.tomcat.util.net.NioBlockingSelector$BlockPoller$1
                * org.apache.tomcat.util.net.NioBlockingSelector$BlockPoller$2
                * org.apache.tomcat.util.net.NioBlockingSelector$BlockPoller$3
                * org.apache.tomcat.util.security.PrivilegedGetTccl
                * org.apache.tomcat.util.security.PrivilegedSetTccl
        1. 通过反射创建`org.apache.catalina.startup.Catalina`实例（startupInstance）
        1. 通过反射，以`sharedLoader`为实参，调用`org.apache.catalina.startup.Catalina`实例（startupInstance）的setParentClassLoader方法
        1. 将`catalinaDaemon`属性设置为`org.apache.catalina.startup.Catalina`实例（startupInstance）
    1. 加载配置，调用`org.apache.catalina.startup.Catalina#load`方法完成
1. org.apache.catalina.startup.Catalina
    1. 使用`Digester`库解析`server.xml`文件
        1. 创建`org.apache.tomcat.util.digester.Digester`实例
        
